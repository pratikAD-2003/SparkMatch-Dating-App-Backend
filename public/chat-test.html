<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Chat Test | Socket.IO</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial;
            max-width: 500px;
            margin: 40px auto;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
        }

        h2 {
            text-align: center;
        }

        #chat-box {
            background: white;
            border-radius: 10px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .msg {
            background: #e4e4e4;
            padding: 8px 10px;
            border-radius: 6px;
            margin: 5px 0;
            width: fit-content;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .sent {
            background: #d0f5d0;
            margin-left: auto;
        }

        .tick {
            font-size: 11px;
            color: gray;
            margin-left: 6px;
        }

        .delivered {
            color: gray;
            /* double gray */
        }

        .seen {
            color: blue;
        }

        .status {
            font-size: 12px;
            color: gray;
            margin-bottom: 5px;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        input,
        button {
            padding: 8px;
            font-size: 14px;
        }

        input {
            flex: 1;
        }

        .meta {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            text-align: right;
        }
    </style>
</head>

<body>
    <h2>Socket.IO Chat Test</h2>
    <div>
        <label>Your User ID:</label>
        <input type="text" id="senderId" placeholder="Enter your userId" />
    </div>
    <div>
        <label>Receiver User ID:</label>
        <input type="text" id="receiverId" placeholder="Enter receiver userId" />
    </div>
    <button id="connectBtn">Connect</button>

    <div id="chatUI" style="display:none;">
        <p class="status" id="status"></p>
        <div id="chat-box"></div>
        <div class="input-row">
            <input type="text" id="msgInput" placeholder="Type a message..." />
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        let socket, senderId, receiverId, chatId;
        const sentElements = new Map();
        let typingTimer;
        let isTyping = false;

        function isWindowActiveAndAtBottom(container) {
            const tolerance = 50;
            return container.scrollHeight - container.scrollTop - container.clientHeight <= tolerance;
        }

        document.getElementById("connectBtn").addEventListener("click", () => {
            senderId = document.getElementById("senderId").value.trim();
            receiverId = document.getElementById("receiverId").value.trim();
            if (!senderId || !receiverId) return alert("Enter both IDs");

            socket = io("http://localhost:5235", {
                query: { token: senderId },
                transports: ["websocket"],
            });

            socket.on("connect", () => {
                console.log("âœ… Connected as", senderId);
                document.getElementById("chatUI").style.display = "block";
            });

            // online/offline indicator
            socket.on("user_status", (data) => {
                if (data.userId === receiverId) {
                    document.getElementById("status").innerText =
                        `${receiverId} is ${data.isOnline ? "ðŸŸ¢ Online" : "ðŸ”´ Offline"}`;
                }
            });

            // ðŸ’¬ Typing indicator from receiver
            socket.on("user_typing", (data) => {
                if (data.userId === receiverId) {
                    const status = document.getElementById("status");
                    if (data.isTyping) {
                        status.innerText = `${receiverId} is typing...`;
                    } else {
                        status.innerText = "";
                    }
                }
            });

            // ðŸ’Œ Receive message
            socket.on("receive_message", (data) => {
                chatId = data.chatId;
                addMessageDOM({
                    id: data.messageId,
                    text: data.message,
                    sent: false,
                    createdAt: data.createdAt,
                });
                socket.emit("join_chat", { chatId });

                const chatBox = document.getElementById("chat-box");
                if (document.visibilityState === "visible" && isWindowActiveAndAtBottom(chatBox)) {
                    socket.emit("mark_seen", { chatId, userId: senderId });
                }
            });

            // ðŸ“¤ Message sent confirmation
            socket.on("message_sent", (data) => {
                chatId = data.chatId;
                addMessageDOM({
                    id: data.messageId,
                    text: data.message,
                    sent: true,
                    createdAt: new Date(),
                });
                socket.emit("join_chat", { chatId });
            });

            // âœ… Message delivered
            socket.on("message_delivered", ({ messageId }) => {
                const el = sentElements.get(messageId);
                if (el) {
                    const tick = el.querySelector(".tick");
                    if (tick) {
                        tick.innerText = "âœ”âœ”";
                        tick.classList.add("delivered");
                    }
                }
            });

            // ðŸ‘€ Seen updates
            socket.on("messages_seen", ({ chatId: seenChatId, seenBy }) => {
                if (seenChatId !== chatId) return;
                if (seenBy === receiverId) {
                    sentElements.forEach((el) => {
                        const tick = el.querySelector(".tick");
                        if (tick) {
                            tick.innerText = "âœ”âœ”";
                            tick.classList.remove("delivered");
                            tick.classList.add("seen");
                        }
                    });
                }
            });

            // âœï¸ Typing emit (debounced)
            const msgInput = document.getElementById("msgInput");
            msgInput.addEventListener("input", () => {
                if (!chatId || !socket) return;
                if (!isTyping) {
                    isTyping = true;
                    socket.emit("typing", { chatId, isTyping: true });
                }

                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    isTyping = false;
                    socket.emit("typing", { chatId, isTyping: false });
                }, 1500);
            });

            // ðŸ“¨ Send message
            document.getElementById("sendBtn").addEventListener("click", sendMsg);
            msgInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMsg();
            });

            // ðŸ§­ Mark seen when active
            window.addEventListener("visibilitychange", () => {
                const chatBox = document.getElementById("chat-box");
                if (document.visibilityState === "visible" && chatId && isWindowActiveAndAtBottom(chatBox)) {
                    socket.emit("mark_seen", { chatId, userId: senderId });
                }
            });

            // ðŸ“œ Mark seen on scroll bottom
            document.getElementById("chat-box").addEventListener("scroll", () => {
                const chatBox = document.getElementById("chat-box");
                if (chatId && isWindowActiveAndAtBottom(chatBox)) {
                    socket.emit("mark_seen", { chatId, userId: senderId });
                }
            });
        });

        // Send message
        function sendMsg() {
            const msgInput = document.getElementById("msgInput");
            const msg = msgInput.value.trim();
            if (!msg) return;
            socket.emit("send_message", { receiverId, message: msg });
            msgInput.value = "";
        }

        // Render message DOM
        function addMessageDOM({ id, text, sent, createdAt }) {
            const box = document.getElementById("chat-box");
            const msg = document.createElement("div");
            msg.classList.add("msg");
            if (sent) msg.classList.add("sent");
            msg.dataset.id = id;

            if (sent) {
                msg.innerHTML = `${escapeHtml(text)} <span class="tick">âœ”</span>
        <div class="meta">${formatTime(createdAt)}</div>`;
                sentElements.set(id, msg);
            } else {
                msg.innerHTML = `${escapeHtml(text)}<div class="meta">${formatTime(createdAt)}</div>`;
            }

            box.appendChild(msg);
            box.scrollTop = box.scrollHeight;
        }

        // Helpers
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        function formatTime(d) {
            const date = new Date(d);
            return date.toLocaleTimeString();
        }
    </script>

</body>

</html>